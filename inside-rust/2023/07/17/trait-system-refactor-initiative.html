<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Rustc Trait System Refactor Initiative Update | Inside Rust Blog</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
<meta name="description" content="Empowering everyone to build reliable and efficient software.">
     <!-- Twitter card -->
 <meta name="twitter:card" content="summary">
 <meta name="twitter:site" content="@rustlang">
 <meta name="twitter:creator" content="@rustlang">
 <meta name="twitter:title" content="Rustc Trait System Refactor Initiative Update | Inside Rust Blog">
 <meta name="twitter:description" content="Want to follow along with Rust development? Curious how you might get involved? Take a look!">
<meta name="twitter:image" content="https://www.rust-lang.org/static/images/rust-social.jpg">

<!-- Facebook OpenGraph -->
<meta property="og:title" content="Rustc Trait System Refactor Initiative Update | Inside Rust Blog" />
<meta property="og:description" content="Want to follow along with Rust development? Curious how you might get involved? Take a look!">
<meta property="og:image" content="https://www.rust-lang.org/static/images/rust-social-wide.jpg" />
<meta property="og:type" content="website" />
<meta property="og:locale" content="en_US" />

<!-- styles -->
<link rel="stylesheet" href="../../../../styles/vendor.css"/>
<link rel="stylesheet" href="../../../../styles/fonts.css"/>
<link rel="stylesheet" href="../../../../styles/app.css"/>
<link rel="stylesheet" href="../../../../styles/highlight.css"/>

<!-- favicon -->
<link rel="apple-touch-icon" sizes="180x180" href="../../../../images/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="16x16" href="../../../../images/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../../../images/favicon-32x32.png">
<link rel="icon" type="image/svg+xml" href="../../../../images/favicon.svg">
<link rel="manifest" href="../../../../images/site.webmanifest">
<link rel="mask-icon" href="../../../../images/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#00aba9">
<meta name="theme-color" content="#ffffff">

 <!-- atom -->
 <link type="application/atom+xml" rel="alternate" href="https://blog.rust-lang.org/inside-rust/feed.xml" title="Inside Rust Blog" />

  </head>
  <body>
    <nav class="flex flex-row justify-center justify-end-l items-center flex-wrap ph2 pl3-ns pr4-ns">
  <div class="brand flex-auto w-100 w-auto-l self-start tc tl-l">
    <a href="../../../../inside-rust/">
      <img class="v-mid ml0-l" alt="Rust Logo" src="../../../../images/rust-logo-blk.svg">
      <span class="dib ml1 ml0-l">Inside Rust Blog</span>
    </a>
  </div>

  <ul class="nav list w-100 w-auto-l flex flex-none flex-row flex-wrap justify-center justify-end-l items-center pv2 ph0 ph4-ns">
    <li class="tc pv2 ph2 ph4-ns flex-20-s"><a href="https://www.rust-lang.org">Rust</a></li>
    <li class="tc pv2 ph2 ph4-ns flex-20-s"><a href="https://www.rust-lang.org/tools/install">Install</a></li>
    <li class="tc pv2 ph2 ph4-ns flex-20-s"><a href="https://www.rust-lang.org/learn">Learn</a></li>
    <li class="tc pv2 ph2 ph4-ns flex-20-s"><a href="https://www.rust-lang.org/tools">Tools</a></li>
    <li class="tc pv2 ph2 ph4-ns flex-20-s"><a href="https://www.rust-lang.org/governance">Governance</a></li>
    <li class="tc pv2 ph2 ph4-ns flex-20-s"><a href="https://www.rust-lang.org/community">Community</a></li>
  </ul>
</nav>

<section id="Rustc Trait System Refactor Initiative Update" class="white">
  <div class="w-100 mw-none ph3 mw8-m mw8-l center f3">
    <header>
      <h2>Rustc Trait System Refactor Initiative Update</h2>
      <div class="highlight mt2 mb3"></div>
    </header>

    <div class="publish-date-author">July 17, 2023 &middot; lcnr
     on behalf of <a href="https://github.com/rust-lang/trait-system-refactor-initiative/">The Rustc Trait System Refactor Initiative</a> 
    </div>

    <div class="post">
      <p>As announced in the <a href="https://blog.rust-lang.org/2023/01/20/types-announcement.html">Types Team announcement post</a> at the start of this year, the Types Team has started to reimplement the trait solver of rustc. This refactor is similar to <a href="https://github.com/rust-lang/chalk/">Chalk</a>, but directly integrated into the existing codebase using the experience gathered over the last few years. Unlike Chalk, the new trait solver has the sole goal of replacing the existing implementation. We are separately working on formalizing the type system in <a href="https://github.com/rust-lang/a-mir-formality">a-mir-formality</a>. It has now been half a year since that announcement which matches the first step of <a href="https://blog.rust-lang.org/2023/01/20/types-announcement.html#roadmap">our roadmap</a>.</p>
<p>By reimplementing the trait solver of rustc we are able to fix many subtle bugs and inefficiencies of the existing implementation. This should result in faster compilation speed and fewer bugs. The new trait solver implementation should also unblock many future changes, most notably around implied bounds and coinduction. For example, it will allow us to remove many of the <a href="https://github.com/rust-lang/rust/issues/91693">current restrictions on GATs</a> and to fix many long-standing unsound issues, like <a href="https://github.com/rust-lang/rust/issues/25860">#25860</a>. Some unsound issues will already be fixed at the point of stabilization while others will require additional work afterwards. The new solver will also enable or greatly simplify other, still experimental type system extensions, e.g. <a href="https://github.com/rust-lang/rust/issues/76560">generic const expressions</a> and <a href="https://github.com/rust-lang/rust/issues/108185">non-lifetime binders</a>.</p>
<h2><a href="#the-status-quo" aria-hidden="true" class="anchor" id="the-status-quo"></a>The status quo</h2>
<p>The new trait solver implementation can be tested on nightly by using the rustc flag <code>-Ztrait-solver=next</code>. To use the new implementation for only coherence checking, <code>-Ztrait-solver=next-coherence</code> can be used. See the current implementation progress of the new trait solver in <a href="https://github.com/rust-lang/rust/issues/107374">its tracking issue</a>.</p>
<p>We are now at a point where we exclusively rely on the new implementation when the feature flag is enabled. This is a major step as we've previously still relied on the old solver for <a href="https://github.com/rust-lang/rust/pull/113086">&quot;deep normalization&quot;</a> and <a href="https://github.com/rust-lang/rust/pull/112869">&quot;selection&quot;</a>. When using the new trait solver many crates and most of our existing regression tests successfully compile.</p>
<p>While there is a significant tail of less common bugs, we currently have two main failure causes:</p>
<p>First, the new solver has a slightly different approach for <code>impl Trait</code>. The implementation of which is still broken for instances of nested return position impl trait, e.g. <code>fn foo() -&gt; impl Trait&lt;Assoc = impl Sized&gt;</code>. Working on this new approach helped us discover issues of the existing implementation, which allows us to refine its design before the stabilization of the <code>type_alias_impl_trait</code> feature.</p>
<p>Second, the inference of implicit <code>Unsize</code> coercions, e.g. converting <code>Box&lt;String&gt;</code> to <code>Box&lt;dyn Display&gt;</code>, relies on implementation details of the existing trait solver. We've recently started to emulate the existing behavior here and should fix most of the remaining breakage from that over the next few weeks.</p>
<h2><a href="#going-forward" aria-hidden="true" class="anchor" id="going-forward"></a>Going forward</h2>
<p>After fixing the currently open issues, we intend to move parts of rustc to the new trait solver implementation in steps, starting by using it in coherence. We expect to move coherence checking to the new implementation at the end of this year. Moving the type checking of functions to the new trait solver implementation will be a lot more challenging. This will be the last place where we will use the old implementation. We expect to change the default there in 2024, potentially relying on the new edition to help with migration.</p>
<p>A major challenge will be &quot;incompleteness&quot;. We use incompleteness as a technical term for cases where the type system unnecessarily guides type inference. Incompleteness allows otherwise ambiguous code to compile, but it also makes the trait system order dependent and can result in incorrect and weird errors. Consider the following example:</p>
<pre><code class="language-rust">fn impl_trait() -&gt; impl Into&lt;u32&gt; {
    0u16
}

fn main() {
    // There are two possible types for `x`:
    // - `u32` by using the &quot;alias bound&quot; of `impl Into&lt;u32&gt;`
    // - `impl Into&lt;u32&gt;`, i.e. `u16`, by using `impl&lt;T&gt; From&lt;T&gt; for T`
    //
    // We infer the type of `x` to be `u32` even though this is not
    // strictly necessary and can even lead to surprising errors.
    let x = impl_trait().into();
    println!(&quot;{}&quot;, std::mem::size_of_val(&amp;x));
}
</code></pre>
<p>How and when we make such inference jumps is quite closely tied to the old trait solver implementation and not something we want to, or even can, copy directly. We have to figure out how to mostly maintain the existing behavior while fitting the rules to the new implementation. The complexity of this issue will only become apparent once the bigger issues are fixed and we start running crater with the new implementation enabled.</p>
<p>Another major hurdle will be error diagnostics. We currently rely on many internal details of the old trait solver implementation to emit actionable and useful errors to the user. These diagnostics have been incrementally improved by relying and working around these internal details. We cannot simply reuse them with the new trait solver implementation. Our goal there is to instead optionally emit &quot;proof trees&quot;, an in-memory representation of how trait solving occurred. We intend provide an simplified API in top of these proof trees which will then be used for diagnostics.</p>

    </div>
  </div>
</section>

    <footer>
  <div class="w-100 mw-none ph3 mw8-m mw9-l center f3">
    <div class="row">
      <div class="four columns mt3 mt0-l" id="get-help">
        <h4>Get help!</h4>
        <ul>
          <li><a href="https://doc.rust-lang.org" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="mailto:core-team@rust-lang.org">Contact the Rust Team</a></li>
        </ul>
      </div>
      <div class="four columns mt3 mt0-l">
        <h4>Terms and policies</h4>
        <ul>
          <li><a href="https://www.rust-lang.org/policies/code-of-conduct">Code of Conduct</a></li>
          <li><a href="https://www.rust-lang.org/policies/licenses">Licenses</a></li>
          <li><a href="https://www.rust-lang.org/policies/media-guide">Logo Policy and Media Guide</a></li>
          <li><a href="https://www.rust-lang.org/policies/security">Security Disclosures</a></li>
          <li><a href="https://www.rust-lang.org/policies">All Policies</a></li>
        </ul>
      </div>
      <div class="four columns mt3 mt0-l">
        <h4>Social</h4>
        <div class="flex flex-row flex-wrap">
          <a href="https://twitter.com/rustlang" target="_blank" rel="noopener" alt="twitter link"><img src="../../../../images/twitter.svg" alt="twitter logo" title="Twitter"/></a>
          <a href="https://www.youtube.com/channel/UCaYhcUwRBNscFNUKTjgPFiA" target="_blank" rel="noopener" alt="youtube link"><img style="padding-top: 6px; padding-bottom:6px" src="../../../../images/youtube.svg" alt="youtube logo" title="YouTube"/></a>
          <a href="https://discord.gg/rust-lang" target="_blank" rel="noopener" alt="discord link"><img src="../../../../images/discord.svg" alt="discord logo" title="Discord"/></a>
          <a href="https://github.com/rust-lang" target="_blank" rel="noopener" alt="github link"><img src="../../../../images/github.svg" alt="github logo" title="GitHub"/></a>
        </div>
        <h4 class="mt4 mb3">RSS</h4>
        <ul>
          <li><a href="../../../../feed.xml">Main Blog</a></li>
          <li><a href="../../../../inside-rust/feed.xml">"Inside Rust" Blog</a></li>
        </ul>
      </div>

    </div>
    <div class="attribution">
      Maintained by the Rust Team. See a typo?
      <a href="https://github.com/rust-lang/blog.rust-lang.org" target="_blank" rel="noopener">Send a fix here</a>!
    </div>
  </div>
</footer>

<!-- scripts -->
<script src="../../../../scripts/highlight.js"></script>

  </body>
</html>
